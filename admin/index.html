<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVTAIR - Supervisor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2C2C2C 0%, #4A4A4A 30%, #666666 70%, #A8A8A8 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border: 1px solid rgba(168, 168, 168, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #1A1A1A 0%, #333333 50%, #4A4A4A 100%);
            color: white;
            padding: 20px 25px;
            text-align: center;
            position: relative;
        }
        
        .company-name {
            color: #A8A8A8;
            font-size: 2.2em;
            font-weight: 300;
            margin-bottom: 5px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
            letter-spacing: 4px;
            font-family: 'Arial', sans-serif;
        }
        
        .page-title {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
            color: white;
        }
        
        .page-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            color: #CCCCCC;
        }
        
        .content {
            padding: 25px;
            background: linear-gradient(135deg, #FAFAFA, #F8FAFC);
        }
        
        .supervisor-selector {
            background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
            border: 2px solid #A5B4FC;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .supervisor-selector h3 {
            color: #3730A3;
            margin-bottom: 15px;
        }
        
        .supervisor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .supervisor-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #E5E5E5;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .supervisor-card:hover {
            border-color: #7C3AED;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.2);
        }
        
        .supervisor-card.selected {
            border-color: #7C3AED;
            background: linear-gradient(135deg, #F3E8FF, #E9D5FF);
        }
        
        .supervisor-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .supervisor-role {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .supervisor-id {
            color: #9ca3af;
            font-size: 0.8em;
            font-family: monospace;
        }
        
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .dashboard.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .dashboard-subtitle {
            color: #6b7280;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 2px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .employees-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .employees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .employee-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .employee-card:hover {
            border-color: #7c3aed;
            transform: translateY(-2px);
        }
        
        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .employee-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .employee-status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .employee-details {
            color: #6b7280;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .employee-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #1A1A1A, #333333);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .loading-message {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #6b7280;
        }
        
        .error-message {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #991b1b;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            border: 2px solid #A7F3D0;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            color: #1E40AF;
            border: 2px solid #BFDBFE;
        }
        
        .back-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        @media (max-width: 768px) {
            .supervisor-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .employees-grid {
                grid-template-columns: 1fr;
            }
            
            .company-name {
                font-size: 1.8em;
            }
            
            .container {
                margin: 5px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="company-name">PVTAIR</div>
            <div class="page-title" id="pageTitle">Supervisor Dashboard</div>
            <div class="page-subtitle" id="pageSubtitle">Select your supervisor profile to access dashboard</div>
        </div>
        
        <div class="content">
            <!-- Supervisor Selection -->
            <div class="supervisor-selector" id="supervisorSelector">
                <h3>Select Your Supervisor Profile</h3>
                <p style="color: #6B7280; margin-bottom: 15px;">
                    Click on your name below to access the supervisor dashboard and manage employee timecards.
                </p>
                <div class="supervisor-grid" id="supervisorGrid">
                    <div class="loading-message">Loading supervisors from Google Sheets...</div>
                </div>
            </div>
            
            <!-- Supervisor Dashboard -->
            <div class="dashboard" id="supervisorDashboard">
                <div class="dashboard-header">
                    <div class="dashboard-title" id="dashboardTitle">Supervisor Dashboard</div>
                    <div class="dashboard-subtitle" id="dashboardSubtitle">Manage employee timecards and oversight</div>
                </div>
                
                <!-- Statistics Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📋</div>
                        <div class="stat-value" id="pendingTimecards">0</div>
                        <div class="stat-label">Pending Timecards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-value" id="approvedTimecards">0</div>
                        <div class="stat-label">Approved This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏰</div>
                        <div class="stat-value" id="totalHours">0</div>
                        <div class="stat-label">Total Hours This Week</div>
                    </div>
                </div>
                
                <!-- Employee List -->
                <div class="employees-section">
                    <h3 class="section-title">
                        <span class="section-icon">👥</span>
                        Employee Management
                    </h3>
                    <div class="employees-grid" id="employeesGrid">
                        <div class="loading-message">Loading employee data from Google Sheets...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="back-button" onclick="backToSelection()" style="display: none;" id="backButton">
        ← Back to Selection
    </button>

    <script>
        // PVTAIR Database - Google Sheets ONLY
        class PVTAIRDatabase {
            constructor() {
                this.spreadsheetId = '1Jo39kWkJcNF-LEymNXmL8PgjipoEDvByyeI71YiElIs';
                this.scriptUrl = 'https://script.google.com/macros/s/AKfycbywtkqW4sWEdw6rOvMoIDLWV_UqC1UiF97_KZW5myAbaQzTwtVevVRDNo2cgBALK7VP/exec';
            }

            async getSupervisors() {
                console.log('Fetching supervisors from Google Sheets...');
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getSupervisors`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log('Supervisors loaded from Google Sheets:', result.data);
                    return result.data || [];
                } catch (error) {
                    console.error('Failed to load supervisors from Google Sheets:', error);
                    throw error;
                }
            }

            async getEmployees() {
                console.log('Fetching employees from Google Sheets...');
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getEmployees`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log('Employees loaded from Google Sheets:', result.data);
                    return result.data || [];
                } catch (error) {
                    console.error('Failed to load employees from Google Sheets:', error);
                    throw error;
                }
            }

            async getTimecards(employeeId = null) {
                console.log('Fetching timecards from Google Sheets...');
                try {
                    let url = `${this.scriptUrl}?action=getTimecards`;
                    if (employeeId) url += `&employeeId=${employeeId}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    console.log('Timecards loaded from Google Sheets:', result.data);
                    return result.data || [];
                } catch (error) {
                    console.error('Failed to load timecards from Google Sheets:', error);
                    throw error;
                }
            }

            async updateTimecardStatus(timecardId, status, supervisorId) {
                console.log(`Updating timecard ${timecardId} status to ${status}`);
                try {
                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateTimecardStatus',
                            timecardId: timecardId,
                            status: status,
                            supervisorId: supervisorId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    return { success: true, message: 'Timecard updated successfully' };
                } catch (error) {
                    console.error('Failed to update timecard:', error);
                    return { success: false, message: error.message };
                }
            }
        }

        // Initialize database
        const database = new PVTAIRDatabase();
        
        // Global variables
        let supervisors = [];
        let employees = [];
        let currentSupervisor = null;
        let timecards = [];
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Supervisor dashboard loaded, initializing...');
            loadSupervisorsFromGoogleSheets();
            
            // Check if supervisor ID is in URL
            const urlParams = new URLSearchParams(window.location.search);
            const supervisorId = urlParams.get('supervisor');
            if (supervisorId) {
                setTimeout(() => selectSupervisor(supervisorId), 2000);
            }
        });
        
        // Load supervisors from Google Sheets ONLY
        async function loadSupervisorsFromGoogleSheets() {
            console.log('Loading supervisors from Google Sheets...');
            
            try {
                supervisors = await database.getSupervisors();
                employees = await database.getEmployees();
                
                if (!supervisors || supervisors.length === 0) {
                    showErrorMessage('No supervisors found in Google Sheets. Please check your spreadsheet.');
                    return;
                }
                
                console.log(`Successfully loaded ${supervisors.length} supervisors and ${employees.length} employees from Google Sheets`);
                generateSupervisorGrid();
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                showErrorMessage('Failed to connect to Google Sheets. Please check your internet connection and try again.');
            }
        }
        
        function generateSupervisorGrid() {
            const grid = document.getElementById('supervisorGrid');
            
            if (!supervisors || supervisors.length === 0) {
                grid.innerHTML = '<div class="error-message">No supervisors found in Google Sheets.</div>';
                return;
            }
            
            // Create supervisor cards from Google Sheets data
            grid.innerHTML = supervisors.map(supervisor => {
                if (!supervisor || !supervisor.id || !supervisor.name) {
                    console.warn('Skipping invalid supervisor:', supervisor);
                    return '';
                }
                
                return `
                    <div class="supervisor-card" onclick="selectSupervisor('${supervisor.id}')">
                        <div class="supervisor-name">${supervisor.name}</div>
                        <div class="supervisor-role">${supervisor.role || 'Supervisor'}</div>
                        <div class="supervisor-id">ID: ${supervisor.id}</div>
                    </div>
                `;
            }).filter(card => card !== '').join('');
            
            console.log('Supervisor grid generated from Google Sheets data');
        }
        
        function selectSupervisor(supervisorId) {
            console.log('Selecting supervisor:', supervisorId);
            
            currentSupervisor = supervisors.find(sup => sup.id === supervisorId);
            if (!currentSupervisor) {
                showAlert('Supervisor not found in Google Sheets data.', 'error');
                return;
            }
            
            // Update header
            document.getElementById('pageTitle').textContent = `${currentSupervisor.name} - Dashboard`;
            document.getElementById('pageSubtitle').textContent = 'Supervisor Management Interface';
            
            // Update dashboard header
            document.getElementById('dashboardTitle').textContent = `Welcome, ${currentSupervisor.name}`;
            document.getElementById('dashboardSubtitle').textContent = 'Manage employee timecards and oversight';
            
            // Hide supervisor selector, show dashboard
            document.getElementById('supervisorSelector').style.display = 'none';
            document.getElementById('supervisorDashboard').classList.add('active');
            document.getElementById('backButton').style.display = 'block';
            
            // Load dashboard data from Google Sheets
            loadDashboardDataFromSheets();
            loadEmployeesListFromSheets();
            
            // Update URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('supervisor', supervisorId);
            window.history.pushState({}, '', newUrl);
        }
        
        async function loadDashboardDataFromSheets() {
            console.log('Loading dashboard statistics from Google Sheets...');
            
            try {
                // Load timecards from Google Sheets
                timecards = await database.getTimecards();
                
                // Calculate real statistics from Google Sheets data
                const totalEmployeesCount = employees.length;
                const pendingCount = timecards.filter(tc => tc.status === 'pending').length;
                const approvedCount = timecards.filter(tc => tc.status === 'approved').length;
                const totalHours = timecards.reduce((sum, tc) => sum + (parseFloat(tc.hoursWorked) || 0), 0);
                
                // Update statistics display
                document.getElementById('totalEmployees').textContent = totalEmployeesCount;
                document.getElementById('pendingTimecards').textContent = pendingCount;
                document.getElementById('approvedTimecards').textContent = approvedCount;
                document.getElementById('totalHours').textContent = Math.round(totalHours);
                
                console.log('Dashboard statistics loaded from Google Sheets');
                
            } catch (error) {
                console.error('Error loading dashboard data from Google Sheets:', error);
                showAlert('Failed to load statistics from Google Sheets', 'error');
            }
        }
        
        function loadEmployeesListFromSheets() {
            const grid = document.getElementById('employeesGrid');
            
            if (!employees || employees.length === 0) {
                grid.innerHTML = '<div class="error-message">No employees found in Google Sheets.</div>';
                return;
            }
            
            console.log('Loading employees list from Google Sheets data');
            
            // Create employee cards from Google Sheets data
            grid.innerHTML = employees.map(employee => {
                if (!employee || !employee.id || !employee.name) {
                    return '';
                }
                
                // Get employee's timecard status from actual data
                const employeeTimecards = timecards.filter(tc => tc.employeeId === employee.id);
                const hasActivePendingCards = employeeTimecards.some(tc => tc.status === 'pending');
                
                return `
                    <div class="employee-card">
                        <div class="employee-header">
                            <div class="employee-name">${employee.name}</div>
                            <div class="employee-status ${hasActivePendingCards ? 'status-pending' : 'status-active'}">
                                ${hasActivePendingCards ? 'Pending Review' : 'Up to Date'}
                            </div>
                        </div>
                        <div class="employee-details">
                            <strong>ID:</strong> ${employee.id}<br>
                            <strong>Role:</strong> ${employee.role || 'Employee'}<br>
                            <strong>Department:</strong> ${employee.department || 'General'}<br>
                            <strong>Timecards:</strong> ${employeeTimecards.length}
                        </div>
                        <div class="employee-actions">
                            <button class="btn btn-primary" onclick="viewEmployeeTimecard('${employee.id}')">
                                View Timecards
                            </button>
                            <button class="btn btn-success" onclick="approveAllTimecards('${employee.id}')" 
                                    ${!hasActivePendingCards ? 'disabled' : ''}>
                                Approve All
                            </button>
                        </div>
                    </div>
                `;
            }).filter(card => card !== '').join('');
            
            console.log('Employees list loaded from Google Sheets data');
        }
        
        // Employee action functions - using Google Sheets data
        async function viewEmployeeTimecard(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            const employeeTimecards = timecards.filter(tc => tc.employeeId === employeeId);
            
            if (employee && employeeTimecards.length > 0) {
                showAlert(`${employee.name} has ${employeeTimecards.length} timecard(s). Opening detailed view...`, 'info');
                // Here you would open a detailed timecard view
            } else {
                showAlert(`No timecards found for ${employee ? employee.name : 'this employee'}`, 'info');
            }
        }
        
        async function approveAllTimecards(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            const pendingTimecards = timecards.filter(tc => tc.employeeId === employeeId && tc.status === 'pending');
            
            if (pendingTimecards.length === 0) {
                showAlert('No pending timecards to approve', 'info');
                return;
            }
            
            try {
                for (const timecard of pendingTimecards) {
                    await database.updateTimecardStatus(timecard.id, 'approved', currentSupervisor.id);
                }
                
                showAlert(`Approved ${pendingTimecards.length} timecard(s) for ${employee.name}`, 'success');
                
                // Reload data to reflect changes
                await loadDashboardDataFromSheets();
                loadEmployeesListFromSheets();
                
            } catch (error) {
                showAlert('Failed to approve timecards. Please try again.', 'error');
            }
        }
        
        function backToSelection() {
            document.getElementById('supervisorDashboard').classList.remove('active');
            document.getElementById('supervisorSelector').style.display = 'block';
            document.getElementById('backButton').style.display = 'none';
            document.getElementById('pageTitle').textContent = 'Supervisor Dashboard';
            document.getElementById('pageSubtitle').textContent = 'Select your supervisor profile to access dashboard';
            currentSupervisor = null;
            
            // Clear URL parameter
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('supervisor');
            window.history.pushState({}, '', newUrl);
        }
        
        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Insert at the top of content
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        function showErrorMessage(message) {
            const grid = document.getElementById('supervisorGrid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>
