<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVTAIR - Reports & Analytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2C2C2C 0%, #4A4A4A 30%, #666666 70%, #A8A8A8 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border: 1px solid rgba(168, 168, 168, 0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #1A1A1A 0%, #333333 50%, #4A4A4A 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .company-name {
            color: #A8A8A8;
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 8px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
            letter-spacing: 5px;
            font-family: 'Arial', sans-serif;
        }
        
        .page-title {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }
        
        .page-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            color: #CCCCCC;
        }
        
        .content {
            padding: 30px;
            background: linear-gradient(135deg, #FAFAFA, #F8FAFC);
        }
        
        .controls-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .controls-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .filter-input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #7c3aed;
        }
        
        .generate-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #d97706, #b45309);
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .report-card:hover {
            border-color: #7c3aed;
            transform: translateY(-2px);
        }
        
        .report-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .report-icon {
            font-size: 2em;
            margin-right: 15px;
            color: #7c3aed;
        }
        
        .report-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
        }
        
        .report-description {
            color: #6b7280;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .summary-stats {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .summary-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            border-color: #7c3aed;
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .table-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            border: 2px solid #A7F3D0;
        }
        
        .alert-error {
            background: linear-gradient(135deg, #FEF2F2, #FECACA);
            color: #991B1B;
            border: 2px solid #FECACA;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            color: #1E40AF;
            border: 2px solid #BFDBFE;
        }
        
        .back-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        @media (max-width: 768px) {
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .generate-buttons {
                flex-direction: column;
            }
            
            .company-name {
                font-size: 2em;
            }
            
            .container {
                margin: 5px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="company-name">PVTAIR</div>
            <div class="page-title">Reports & Analytics</div>
            <div class="page-subtitle">Comprehensive timecard reporting and data analysis</div>
        </div>
        
        <div class="content">
            <!-- Report Generation Controls -->
            <div class="controls-section">
                <h2 class="controls-title">üìä Generate Reports</h2>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Date Range</label>
                        <select id="dateRange" class="filter-input">
                            <option value="this-week">This Week</option>
                            <option value="last-week">Last Week</option>
                            <option value="this-month">This Month</option>
                            <option value="last-month">Last Month</option>
                            <option value="this-quarter">This Quarter</option>
                            <option value="this-year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" id="startDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" id="endDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Employee</label>
                        <select id="employeeFilter" class="filter-input">
                            <option value="all">All Employees</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Department</label>
                        <select id="departmentFilter" class="filter-input">
                            <option value="all">All Departments</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-input">
                            <option value="all">All Statuses</option>
                            <option value="approved">Approved</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="generate-buttons">
                    <button class="btn" onclick="generateSummaryReport()">üìà Summary Report</button>
                    <button class="btn btn-secondary" onclick="generateDetailedReport()">üìã Detailed Report</button>
                    <button class="btn btn-success" onclick="generatePayrollReport()">üí∞ Payroll Report</button>
                    <button class="btn btn-warning" onclick="exportToExcel()">üìä Export Excel</button>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="summary-stats">
                <h2 class="summary-title">üìä Summary Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalHours">0</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalTimecards">0</div>
                        <div class="stat-label">Total Timecards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgHoursPerDay">0</div>
                        <div class="stat-label">Avg Hours/Day</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingApprovals">0</div>
                        <div class="stat-label">Pending Approvals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeEmployees">0</div>
                        <div class="stat-label">Active Employees</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPayroll">$0</div>
                        <div class="stat-label">Est. Payroll</div>
                    </div>
                </div>
            </div>

            <!-- Available Reports -->
            <div class="reports-grid">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">üìà</div>
                        <div class="report-title">Weekly Summary</div>
                    </div>
                    <div class="report-description">
                        Weekly timecard summary with hours worked, overtime, and approval status for all employees.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generateWeeklySummary()">Generate</button>
                        <button class="btn btn-secondary" onclick="scheduleWeeklyReport()">Schedule</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">üí∞</div>
                        <div class="report-title">Payroll Analysis</div>
                    </div>
                    <div class="report-description">
                        Detailed payroll calculations including regular hours, overtime, and total compensation.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generatePayrollAnalysis()">Generate</button>
                        <button class="btn btn-secondary" onclick="exportPayrollData()">Export</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">üë•</div>
                        <div class="report-title">Employee Performance</div>
                    </div>
                    <div class="report-description">
                        Individual employee performance metrics including attendance, hours worked, and trends.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generatePerformanceReport()">Generate</button>
                        <button class="btn btn-secondary" onclick="compareEmployees()">Compare</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">üè¢</div>
                        <div class="report-title">Department Analysis</div>
                    </div>
                    <div class="report-description">
                        Department-wise breakdown of hours, costs, and productivity metrics across all teams.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generateDepartmentReport()">Generate</button>
                        <button class="btn btn-secondary" onclick="compareDepartments()">Compare</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">üìã</div>
                        <div class="report-title">Audit Report</div>
                    </div>
                    <div class="report-description">
                        Comprehensive audit trail of timecard submissions, approvals, and system changes.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generateAuditReport()">Generate</button>
                        <button class="btn btn-secondary" onclick="exportAuditLog()">Export Log</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon">‚ö†Ô∏è</div>
                        <div class="report-title">Exception Report</div>
                    </div>
                    <div class="report-description">
                        Identify anomalies, missing timecards, overtime violations, and compliance issues.
                    </div>
                    <div class="report-actions">
                        <button class="btn" onclick="generateExceptionReport()">Generate</button>
                        <button class="btn btn-warning" onclick="downloadAlerts()">Download Alerts</button>
                    </div>
                </div>
            </div>

            <!-- Recent Timecards Table -->
            <div class="data-table">
                <h2 class="table-title">üìã Recent Timecard Activity</h2>
                <div class="table-container">
                    <table id="recentTimecards">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Hours</th>
                                <th>Status</th>
                                <th>Supervisor</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody id="timecardTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6b7280;">Loading timecard data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Generating report...</div>
        </div>
    </div>

    <a href="../" class="back-button">‚Üê Back to Dashboard</a>

    <script src="../assets/js/database.js"></script>
    <script>
        // Global data storage
        let reportData = {
            employees: [],
            timecards: [],
            supervisors: [],
            stats: {}
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Reports dashboard loaded, initializing...');
            setupDateRangeControls();
            loadReportData();
        });

        // Initialize date controls
        function setupDateRangeControls() {
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Handle date range selection
            document.getElementById('dateRange').addEventListener('change', function() {
                updateDateRange(this.value);
            });
        }

        // Update date inputs based on range selection
        function updateDateRange(range) {
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            let startDate, endDate;
            
            switch(range) {
                case 'this-week':
                    startDate = getWeekStart(today);
                    endDate = today;
                    break;
                case 'last-week':
                    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    startDate = getWeekStart(lastWeek);
                    endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
                    break;
                case 'this-month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'last-month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'this-quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = today;
                    break;
                case 'this-year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                default:
                    return; // Custom range - don't update
            }
            
            if (startDate && endDate) {
                startDateInput.value = startDate.toISOString().split('T')[0];
                endDateInput.value = endDate.toISOString().split('T')[0];
            }
        }

        // Get week start date (Sunday)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // Load all report data from Google Sheets
        async function loadReportData() {
            showAlert('Loading report data from Google Sheets...', 'info');
            
            try {
                // Load all data in parallel
                const [employees, timecards, supervisors] = await Promise.all([
                    database.getEmployees(),
                    database.getTimecards(),
                    database.getSupervisors()
                ]);

                reportData.employees = employees;
                reportData.timecards = timecards;
                reportData.supervisors = supervisors;

                // Populate filter dropdowns
                populateEmployeeFilter(employees);
                populateDepartmentFilter(employees);
                
                // Calculate and display statistics
                calculateReportStats();
                
                // Load recent timecards table
                loadRecentTimecardsTable();
                
                showAlert('Report data loaded successfully', 'success');
                console.log('Report data loaded:', reportData);

            } catch (error) {
                console.error('Error loading report data:', error);
                showAlert('Failed to load report data from Google Sheets', 'error');
                displayErrorStats();
            }
        }

        // Populate employee filter dropdown
        function populateEmployeeFilter(employees) {
            const select = document.getElementById('employeeFilter');
            select.innerHTML = '<option value="all">All Employees</option>';
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }

        // Populate department filter dropdown
        function populateDepartmentFilter(employees) {
            const departments = [...new Set(employees.map(emp => emp.department).filter(d => d))];
            const select = document.getElementById('departmentFilter');
            select.innerHTML = '<option value="all">All Departments</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        // Calculate and display report statistics
        function calculateReportStats() {
            const { employees, timecards } = reportData;
            
            // Filter timecards based on current date range
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            const filteredTimecards = timecards.filter(tc => {
                const tcDate = new Date(tc.date);
                return tcDate >= startDate && tcDate <= endDate;
            });

            // Calculate statistics
            const totalHours = filteredTimecards.reduce((sum, tc) => sum + (parseFloat(tc.hoursWorked) || 0), 0);
            const totalTimecards = filteredTimecards.length;
            const pendingApprovals = filteredTimecards.filter(tc => tc.status === 'pending').length;
            const activeEmployees = new Set(filteredTimecards.map(tc => tc.employeeId)).size;
            
            // Calculate average hours per day
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const avgHoursPerDay = daysDiff > 0 ? totalHours / daysDiff : 0;
            
            // Estimate payroll (assuming $20/hour average)
            const estimatedPayroll = totalHours * 20;

            // Update display
            document.getElementById('totalHours').textContent = Math.round(totalHours);
            document.getElementById('totalTimecards').textContent = totalTimecards;
            document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay.toFixed(1);
            document.getElementById('pendingApprovals').textContent = pendingApprovals;
            document.getElementById('activeEmployees').textContent = activeEmployees;
            document.getElementById('totalPayroll').textContent = `$${estimatedPayroll.toLocaleString()}`;
        }

        // Load recent timecards table
        function loadRecentTimecardsTable() {
            const tbody = document.getElementById('timecardTableBody');
            const { timecards, employees, supervisors } = reportData;
            
            if (!timecards || timecards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No timecard data available</td></tr>';
                return;
            }

            // Sort by date (most recent first) and take top 20
            const recentTimecards = timecards
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20);

            tbody.innerHTML = recentTimecards.map(tc => {
                const employee = employees.find(emp => emp.id === tc.employeeId);
                const supervisor = supervisors.find(sup => sup.id === tc.supervisorId);
                
                return `
                    <tr>
                        <td>${new Date(tc.date).toLocaleDateString()}</td>
                        <td>${employee ? employee.name : tc.employeeId}</td>
                        <td>${employee ? employee.department || 'N/A' : 'N/A'}</td>
                        <td>${tc.hoursWorked || 0}</td>
                        <td><span class="status-badge status-${tc.status}">${tc.status.toUpperCase()}</span></td>
                        <td>${supervisor ? supervisor.name : tc.supervisorId || 'N/A'}</td>
                        <td>${tc.submittedAt ? new Date(tc.submittedAt).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Display error statistics when data fails to load
        function displayErrorStats() {
            document.getElementById('totalHours').textContent = '?';
            document.getElementById('totalTimecards').textContent = '?';
            document.getElementById('avgHoursPerDay').textContent = '?';
            document.getElementById('pendingApprovals').textContent = '?';
            document.getElementById('activeEmployees').textContent = '?';
            document.getElementById('totalPayroll').textContent = '?';
            
            const tbody = document.getElementById('timecardTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Failed to load timecard data</td></tr>';
        }

        // Show loading overlay
        function showLoading(message = 'Generating report...') {
            const overlay = document.getElementById('loadingOverlay');
            const content = overlay.querySelector('.loading-content div:last-child');
            content.textContent = message;
            overlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Get current filter values
        function getCurrentFilters() {
            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                employeeId: document.getElementById('employeeFilter').value,
                department: document.getElementById('departmentFilter').value,
                status: document.getElementById('statusFilter').value
            };
        }

        // Filter timecards based on current filters
        function getFilteredTimecards() {
            const filters = getCurrentFilters();
            let filtered = reportData.timecards;

            // Date range filter
            if (filters.startDate && filters.endDate) {
                const startDate = new Date(filters.startDate);
                const endDate = new Date(filters.endDate);
                filtered = filtered.filter(tc => {
                    const tcDate = new Date(tc.date);
                    return tcDate >= startDate && tcDate <= endDate;
                });
            }

            // Employee filter
            if (filters.employeeId && filters.employeeId !== 'all') {
                filtered = filtered.filter(tc => tc.employeeId === filters.employeeId);
            }

            // Department filter
            if (filters.department && filters.department !== 'all') {
                filtered = filtered.filter(tc => {
                    const employee = reportData.employees.find(emp => emp.id === tc.employeeId);
                    return employee && employee.department === filters.department;
                });
            }

            // Status filter
            if (filters.status && filters.status !== 'all') {
                filtered = filtered.filter(tc => tc.status === filters.status);
            }

            return filtered;
        }

        // Report generation functions
        async function generateSummaryReport() {
            showLoading('Generating summary report...');
            
            try {
                const filteredTimecards = getFilteredTimecards();
                const filters = getCurrentFilters();
                
                // Simulate report generation delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Create summary report data
                const summary = {
                    dateRange: `${filters.startDate} to ${filters.endDate}`,
                    totalTimecards: filteredTimecards.length,
                    totalHours: filteredTimecards.reduce((sum, tc) => sum + (parseFloat(tc.hoursWorked) || 0), 0),
                    approvedTimecards: filteredTimecards.filter(tc => tc.status === 'approved').length,
                    pendingTimecards: filteredTimecards.filter(tc => tc.status === 'pending').length,
                    rejectedTimecards: filteredTimecards.filter(tc => tc.status === 'rejected').length
                };
                
                hideLoading();
                showAlert(`Summary report generated: ${summary.totalTimecards} timecards, ${Math.round(summary.totalHours)} total hours`, 'success');
                
                // In a real system, you would download or display the report
                console.log('Summary Report:', summary);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate summary report', 'error');
            }
        }

        async function generateDetailedReport() {
            showLoading('Generating detailed report...');
            
            try {
                const filteredTimecards = getFilteredTimecards();
                
                // Simulate report generation delay
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                hideLoading();
                showAlert(`Detailed report generated with ${filteredTimecards.length} timecard entries`, 'success');
                
                // In a real system, you would download the detailed report
                console.log('Detailed Report:', filteredTimecards);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate detailed report', 'error');
            }
        }

        async function generatePayrollReport() {
            showLoading('Generating payroll report...');
            
            try {
                const filteredTimecards = getFilteredTimecards().filter(tc => tc.status === 'approved');
                
                // Group by employee
                const payrollData = {};
                filteredTimecards.forEach(tc => {
                    if (!payrollData[tc.employeeId]) {
                        const employee = reportData.employees.find(emp => emp.id === tc.employeeId);
                        payrollData[tc.employeeId] = {
                            employee: employee,
                            totalHours: 0,
                            regularHours: 0,
                            overtimeHours: 0,
                            totalPay: 0
                        };
                    }
                    
                    const hours = parseFloat(tc.hoursWorked) || 0;
                    payrollData[tc.employeeId].totalHours += hours;
                    
                    // Calculate regular vs overtime (assuming 8 hours per day is regular)
                    if (hours <= 8) {
                        payrollData[tc.employeeId].regularHours += hours;
                    } else {
                        payrollData[tc.employeeId].regularHours += 8;
                        payrollData[tc.employeeId].overtimeHours += (hours - 8);
                    }
                });
                
                // Calculate pay (using base salary or estimated rate)
                Object.values(payrollData).forEach(data => {
                    const hourlyRate = data.employee && data.employee.baseSalary ? 
                        data.employee.baseSalary / 2080 : 20; // 2080 = 40 hours/week * 52 weeks
                    
                    data.totalPay = (data.regularHours * hourlyRate) + (data.overtimeHours * hourlyRate * 1.5);
                });
                
                // Simulate report generation delay
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                hideLoading();
                const totalPayroll = Object.values(payrollData).reduce((sum, data) => sum + data.totalPay, 0);
                showAlert(`Payroll report generated for ${Object.keys(payrollData).length} employees. Total payroll: ${totalPayroll.toLocaleString()}`, 'success');
                
                console.log('Payroll Report:', payrollData);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate payroll report', 'error');
            }
        }

        async function exportToExcel() {
            showLoading('Preparing Excel export...');
            
            try {
                const filteredTimecards = getFilteredTimecards();
                
                // Simulate export preparation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // In a real system, you would use the database export function
                const result = await database.exportData('timecards', 'excel');
                
                hideLoading();
                showAlert(`Excel file prepared with ${filteredTimecards.length} records. Download ready.`, 'success');
                
                // In a real system, trigger download
                console.log('Excel Export Result:', result);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to export to Excel', 'error');
            }
        }

        // Specific report generation functions
        async function generateWeeklySummary() {
            showLoading('Generating weekly summary...');
            
            try {
                // Set date range to current week
                document.getElementById('dateRange').value = 'this-week';
                updateDateRange('this-week');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hideLoading();
                showAlert('Weekly summary report generated successfully', 'success');
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate weekly summary', 'error');
            }
        }

        async function generatePayrollAnalysis() {
            await generatePayrollReport();
        }

        async function generatePerformanceReport() {
            showLoading('Analyzing employee performance...');
            
            try {
                const timecards = getFilteredTimecards();
                
                // Group by employee and analyze performance
                const performance = {};
                timecards.forEach(tc => {
                    if (!performance[tc.employeeId]) {
                        const employee = reportData.employees.find(emp => emp.id === tc.employeeId);
                        performance[tc.employeeId] = {
                            employee: employee,
                            totalDays: 0,
                            totalHours: 0,
                            avgHoursPerDay: 0,
                            onTimeSubmissions: 0,
                            lateSubmissions: 0
                        };
                    }
                    
                    performance[tc.employeeId].totalDays++;
                    performance[tc.employeeId].totalHours += parseFloat(tc.hoursWorked) || 0;
                    
                    // Check if submission was on time (submitted same day as work date)
                    const workDate = new Date(tc.date);
                    const submitDate = new Date(tc.submittedAt);
                    
                    if (submitDate.toDateString() === workDate.toDateString()) {
                        performance[tc.employeeId].onTimeSubmissions++;
                    } else {
                        performance[tc.employeeId].lateSubmissions++;
                    }
                });
                
                // Calculate averages
                Object.values(performance).forEach(perf => {
                    perf.avgHoursPerDay = perf.totalDays > 0 ? perf.totalHours / perf.totalDays : 0;
                });
                
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                hideLoading();
                showAlert(`Performance analysis completed for ${Object.keys(performance).length} employees`, 'success');
                
                console.log('Performance Report:', performance);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate performance report', 'error');
            }
        }

        async function generateDepartmentReport() {
            showLoading('Analyzing department data...');
            
            try {
                const timecards = getFilteredTimecards();
                
                // Group by department
                const departments = {};
                timecards.forEach(tc => {
                    const employee = reportData.employees.find(emp => emp.id === tc.employeeId);
                    const dept = employee ? employee.department || 'Unknown' : 'Unknown';
                    
                    if (!departments[dept]) {
                        departments[dept] = {
                            totalHours: 0,
                            totalTimecards: 0,
                            employees: new Set(),
                            avgHoursPerEmployee: 0
                        };
                    }
                    
                    departments[dept].totalHours += parseFloat(tc.hoursWorked) || 0;
                    departments[dept].totalTimecards++;
                    departments[dept].employees.add(tc.employeeId);
                });
                
                // Calculate averages
                Object.values(departments).forEach(dept => {
                    dept.employeeCount = dept.employees.size;
                    dept.avgHoursPerEmployee = dept.employeeCount > 0 ? dept.totalHours / dept.employeeCount : 0;
                    delete dept.employees; // Remove Set for console display
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hideLoading();
                showAlert(`Department analysis completed for ${Object.keys(departments).length} departments`, 'success');
                
                console.log('Department Report:', departments);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate department report', 'error');
            }
        }

        async function generateAuditReport() {
            showLoading('Generating audit report...');
            
            try {
                const timecards = getFilteredTimecards();
                
                // Create audit trail
                const auditData = timecards.map(tc => ({
                    timecardId: tc.id,
                    employeeId: tc.employeeId,
                    date: tc.date,
                    hoursWorked: tc.hoursWorked,
                    status: tc.status,
                    submittedAt: tc.submittedAt,
                    supervisorId: tc.supervisorId,
                    approvedAt: tc.approvedAt || null,
                    lastModified: tc.lastModified || tc.submittedAt
                }));
                
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                hideLoading();
                showAlert(`Audit report generated with ${auditData.length} entries`, 'success');
                
                console.log('Audit Report:', auditData);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate audit report', 'error');
            }
        }

        async function generateExceptionReport() {
            showLoading('Identifying exceptions and anomalies...');
            
            try {
                const timecards = getFilteredTimecards();
                const exceptions = [];
                
                timecards.forEach(tc => {
                    const hours = parseFloat(tc.hoursWorked) || 0;
                    
                    // Check for various exceptions
                    if (hours > 12) {
                        exceptions.push({
                            type: 'EXCESSIVE_HOURS',
                            timecardId: tc.id,
                            employeeId: tc.employeeId,
                            date: tc.date,
                            value: hours,
                            description: `Employee worked ${hours} hours in one day`
                        });
                    }
                    
                    if (hours < 1 && tc.status === 'approved') {
                        exceptions.push({
                            type: 'MINIMAL_HOURS',
                            timecardId: tc.id,
                            employeeId: tc.employeeId,
                            date: tc.date,
                            value: hours,
                            description: `Approved timecard with only ${hours} hours`
                        });
                    }
                    
                    if (tc.status === 'pending' && tc.submittedAt) {
                        const daysSinceSubmission = (Date.now() - new Date(tc.submittedAt)) / (1000 * 60 * 60 * 24);
                        if (daysSinceSubmission > 7) {
                            exceptions.push({
                                type: 'LONG_PENDING',
                                timecardId: tc.id,
                                employeeId: tc.employeeId,
                                date: tc.date,
                                value: Math.round(daysSinceSubmission),
                                description: `Timecard pending for ${Math.round(daysSinceSubmission)} days`
                            });
                        }
                    }
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hideLoading();
                showAlert(`Exception report completed. Found ${exceptions.length} exceptions`, exceptions.length > 0 ? 'warning' : 'success');
                
                console.log('Exception Report:', exceptions);
                
            } catch (error) {
                hideLoading();
                showAlert('Failed to generate exception report', 'error');
            }
        }

        // Scheduling and additional functions
        function scheduleWeeklyReport() {
            showAlert('Weekly report scheduling configured', 'info');
            // TODO: Implement report scheduling
        }

        function exportPayrollData() {
            showAlert('Preparing payroll data export...', 'info');
            generatePayrollReport();
        }

        function compareEmployees() {
            showAlert('Opening employee comparison tool...', 'info');
            // TODO: Open comparison interface
        }

        function compareDepartments() {
            showAlert('Opening department comparison tool...', 'info');
            // TODO: Open comparison interface
        }

        function exportAuditLog() {
            showAlert('Exporting audit log...', 'info');
            generateAuditReport();
        }

        function downloadAlerts() {
            showAlert('Preparing exception alerts download...', 'info');
            generateExceptionReport();
        }

        // Utility function to show alerts
        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Insert at the top of content
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Listen for database ready event
        window.addEventListener('databaseReady', function(event) {
            console.log('Database is ready for reports');
            // Database is already initialized by the time this page loads
        });

        // Refresh data when filters change
        document.getElementById('startDate').addEventListener('change', calculateReportStats);
        document.getElementById('endDate').addEventListener('change', calculateReportStats);
        document.getElementById('employeeFilter').addEventListener('change', calculateReportStats);
        document.getElementById('departmentFilter').addEventListener('change', calculateReportStats);
        document.getElementById('statusFilter').addEventListener('change', calculateReportStats);
    </script>
</body>
</html>
